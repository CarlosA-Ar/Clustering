---
title: "K-modas"
author: "Carlos A. Ar."
date: "`r format(Sys.Date(), '%d de %B del %Y')`"
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
---

```{=html}
<style>
  body {
    font-size: 17px;
  }
</style>
```
```{r setup, include=FALSE}
library(knitr)
library(klaR)
library(rmdformats)
library(DT)
library(ggplot2)
library(gridExtra)

## Global options
options(max.print="75")
opts_chunk$set(tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

# 쮻e qu칠 trata?

1.  Tenemos un data-set con "$n$" observaciones, donde cada observaci칩n es de dimensi칩n "$p$".

2.  Las entradas de cada observaci칩n **son etiquetas** de una categor칤a.

    **Ejemplo.**

    $$
    \begin{align*}
    &(\text{mujer}, \text{soltera}, \text{empleada}) \\
    & p = 3
    \end{align*}
    $$

    -   La primer categor칤a es el sexo.

    -   La segunda categor칤a es el estado civ칤l.

    -   La tercer categor칤a es la situaci칩n laboral.

3.  Las etiquetas se asocian con n칰meros naturales

    **Ejemplo:**

    ```{=tex}
    \begin{align*}

    \text{Sexo } &= \begin{cases}
    1: \text{mujer} \\
    2: \text{hombre}
    \end{cases} 
    \\
    \text{Estado Civil} &= \begin{cases}
    1: \text{Solter@} \\
    2: \text{Casad@} \\
    3: \text{Viud@}
    \end{cases} 
    \\
    \text{Situaci칩n Laboral} &= \begin{cases}
    1: \text{Emplead@} \\
    2: \text{Desemplead@}
    \end{cases} \\
    \\
    (1&, 1, 1)

    \end{align*}
    ```

# Lo matem치tico

Queremos saber **쮺u치nto se parece una observaci칩n *(como las mencionadas)* a otra?**

## Construcci칩n

-   Sea $n_k$ el n칰mero de etiquetas de la $k-칠sima$ categor칤a ($k \in \{1, ..., p\}$).

-   Sea $x_i = (c_{i_1, 1}, c_{i_2, 2},..., c_{i_p, p})$ la $i-칠sima$ observaci칩n del data set ($i \in \{1, ..., n\}$).

    -   Donde $c_{i_k, k}$ representa la $i-칠sima$ etiqueta correspondiente a la categor칤a $k$ ($1\leq i_k \leq n_k$).

-   Fijamos $k$ *(una columna),* definimos la funci칩n $\delta(\cdot, \cdot)$ dada por:

    $$
    \delta(c_{i_k, k}, c_{j_k, k}) = 
    \begin{cases} 
    0, \text{ si } c_{i_k, k} = c_{j_k, k}, \\
    1, \text{ si } c_{i_k, k} \neq c_{j_k, k}
    \end{cases}
    $$

    Es decir, $0$ si las etiquetas de los renglones $i$ y $j$ son iguales *(dentro de la misma categor칤a)* y $1$ si son diferentes.

    -   **Ejemplo**

        $$
        \delta(\text{hombre}, \text{mujer}) = 1  \iff \delta(2,1) = 1 \\
        \delta(\text{casad@}, \text{casad@}) = 0  \iff \delta(2,1) = 0
        $$

### Disimilaridad *(Zhexue Huang 1998)* {#disim}

Sean $i, j \in \{1, ..., n \}$. La disimilaridad entre las observaciones $i$ y $j$ es:

$$
d(x_i, x_j) := \sum_{k=1}^p \delta(c_{i_k, k}, c_{j_k, k})
$$

-   $d(x_i, x_j)$ "nos dice" el n칰mero de entradas diferentes entre los vectores $x_i$ y $x_j$.

    -   Si $d(x_i, x_j)$ est치 cerca de $p$, entonces $x_i$ y $x_j$ "no se parecen".

    -   Si $d(x_i, x_j)$ est치 cerca de $0$, entonces $x_i$ y $x_j$ "se parecen".

## 쮺칩mo se relaciona con $k-$modas?

-   Queremos hacer $k$ grupos/cl칰sters tales que en cada uno, las observaciones se parezcan entre s칤.

-   Para lo anterior, buscamos **un representante** que llamaremos **moda**.

    -   Tal representante debe estar "lo m치s cerca posible" de las observaciones que est치n en el cl칰ster.

### Moda *(definici칩n)*

Decimos que el vector $Q = (q_1, ..., q_p)$ es moda de la muestra (o del conjunto de observaciones) $\mathbb{X} = \{ x_1, x_2, ..., x_n\}$ si

$$
D(\mathbb{X}, Q) := \sum_{i=1}^n d(x_i, Q)
$$ es la m칤nima posible. *La moda minimiza la distancia.*

-   Por definici칩n, $Q$ no tiene que ser parte de la muestra.

### 쮺칩mo encontrar $Q$?

Hay un teorema que garantiza que si contruimos un vector $Q$ de la siguiente forma, tal vector ser치 la moda *(el vector moda)*.

1.  Cuenta el n칰mero de veces que se repite cada etiqueta en cada categor칤a.
2.  Observa el m치ximo de los anteriores.
3.  Pon en el vector $Q$, la etiqueta correspondiente a dicho m치ximo.

**Ejemplo.**

| Observaci칩n | Sexo | Estado Civil | Situaci칩n Laboral |
|:-----------:|:----:|:------------:|:-----------------:|
|   **1.**    |  1   |      3       |         2         |
|   **2.**    |  1   |      1       |         2         |
|   **3.**    |  1   |      3       |         2         |
|   **4.**    |  1   |      2       |         2         |
|   **5.**    |  1   |      2       |         2         |
|   **6.**    |  2   |      3       |         2         |
|   **7.**    |  2   |      3       |         1         |
|   **8.**    |  1   |      1       |         1         |
|   **9.**    |  1   |      3       |         1         |
|   **10.**   |  2   |      1       |         1         |

Por lo tanto $Q = (1, 3, 2)$

# Algoritmo $k-modas$

<div>

<p style="text-align:center;">

![](km_1.png){width="150px"}

</p>

</div>

1.  Toma $k$ representantes (modas iniciales).
2.  "Junta" la observaci칩n que tenga la menor distancia ($d$) con uno de los $k$ representantes (modas).
3.  Calcula la moda en cada grupo.
4.  Repite el paso 2 y 3 hasta que todas las observaciones est칠n asignadas a un solo cl칰ster.

<div>

<p style="text-align:center;">

![](km_2.png){width="150px"}

</p>

</div>

## Implementaci칩n en R

Con la funci칩n `kmodes` se tiene lo necesario para obtener los cl칰sters, las observaciones que pertenecen a cada cl칰ster, las modas en cada cl칰ster y otras cantidades.

### Par치metros de `kmodes`

-   `data`: una matriz de n칰meros enteros o un data frame de datos correspondientes a variables categ칩ricas.

-   `modes`:

    -   Si se iguala a un n칰mero, este representar치 el n칰mero de cl칰sters deseados *las modas iniciales se tomar치n aleatoriamente del data-set.*

    -   Si se iguala a un vector de observaciones, tales observaciones ser치n las modas iniciales.

-   `iter.max`: el n칰mero m치ximo de iteraciones *(del algoritmo)* permitidas*.*

-   `weighted`: es un booleano. Por defecto es `FALSE`, si es `TRUE` entonces la distancia no ser치 la definida en el apartado de [Disimilaridad (Zhexue Huang 1998)](#disim) sino una ponderada.

-   `fast`: es un valor l칩gico (`T/F`) que se usa para hacer m치s r치pido el algoritmo cuando hay muchas observaciones (`T`).

    -   Cuando no se usa, el algoritmo hace las asignaciones de cada observaci칩n y se recalcula la moda. Cuando se usa, se hacen las asignaciones con las modas iniciales para todas las observaciones y por 칰ltimo se recalcula la moda 游.

```{r, eval=FALSE, echo=TRUE}
# Instalar klaR
install.packages("klaR")

# Cargar librer칤a
library(klaR)
```

### Ejemplo

Consideremos una tabla de datos personales con cinco categor칤as:

+------------+-------------------+-------------------+----------------+---------------+
| Sexo       | Estado Civil      | Situaci칩n Laboral | Grupo de edad  | Nivel escolar |
+:==========:+:=================:+:=================:+:==============:+:=============:+
| 1.  Hombre | 1.  Casado(a)     | 1.  Desmpleado(a) | 1.  Adulto(a)  | 1.  Avanzado  |
+------------+-------------------+-------------------+----------------+---------------+
| 2.  Mujer  | 2.  Viudo(a)      | 2.  Empleado(a)   | 2.  Anciano(a) | 2.  B치sico    |
+------------+-------------------+-------------------+----------------+---------------+
|            | 3.  Soltero(a)    |                   | 3.  Joven      | 3.  Medio     |
+------------+-------------------+-------------------+----------------+---------------+
|            | 4.  Divorciado(a) |                   | 4.  Ni침o(a)    |               |
+------------+-------------------+-------------------+----------------+---------------+

```{r, include=FALSE}
set.seed(1)
sexo<-as.factor(sample(c("hombre", "mujer"),2000,TRUE,c(0.5, 0.5)))

estado_civil<-as.factor(sample(c("solterx", "casadx", "viudx", "divorciadx"),2000,TRUE,c(0.55, 0.3, 0.1, 0.05)))

situ_labo<-as.factor(sample(c("empleadx", "desempleadx"),2000,TRUE,c(0.7, 0.3)))

grpo_edad <- as.factor(sample(c("ninx", "joven", "adulto", "ancianx"),2000,TRUE,c(0.05, 0.35, 0.4, 0.2)))

niv_educ <- as.factor(sample(c("basico", "medio", "avanzado"),2000,TRUE,c(0.6, 0.3, 0.1)))


info_personal <- as.data.frame(cbind(sexo, estado_civil ,situ_labo, grpo_edad, niv_educ))

info_personal$sexo <- as.factor(info_personal$sexo)
info_personal$estado_civil <- as.factor(info_personal$estado_civil)
info_personal$situ_labo <- as.factor(info_personal$situ_labo)
info_personal$grpo_edad <- as.factor(info_personal$grpo_edad)
info_personal$niv_educ <- as.factor(info_personal$niv_educ)
```

```{r, echo=FALSE, fig.align='center'}
grid.arrange( 
  
ggplot(info_personal, aes(x = sexo)) + geom_bar(fill = c("#922B21", "#CD6155")) + ggtitle("Sexo") + theme_minimal(),

ggplot(info_personal, aes(x = estado_civil)) + geom_bar(fill = c("#1B4F72", "#21618C", "#2874A6", "#D4E6F1")) + ggtitle("Estado Civil") + theme_minimal(),

ggplot(info_personal, aes(x = situ_labo)) + geom_bar(fill = c("#F8C471", "#F39C12")) + ggtitle("Situaci칩n Laboral") + theme_minimal(),

ggplot(info_personal, aes(x = grpo_edad)) + geom_bar(fill = c("#512E5F", "#9B59B6", "#D7BDE2", "#F5EEF8")) + ggtitle("Grupo Edad") + theme_minimal(),
  
  ggplot(info_personal, aes(x = niv_educ)) + geom_bar(fill = c("#0E6251", "#17A589", "#A2D9CE")) + ggtitle("Nivel Educativo") +  theme_minimal(),

  ncol = 3, top  = "Informaci칩n Personal")
```

```{r, echo=FALSE}
DT::datatable(
  info_personal, 
  caption = "Datos personales",
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    dom = "Bfrtip",
    buttons = c("csv")
  )
)
```

#### `kmodes`

```{r}
set.seed(1)
k_modelo <- kmodes(data = info_personal, modes = 2, iter.max = 10)

# Modas por cl칰ster
k_modelo$modes

# Tama침o de los cl칰sters
k_modelo$size

# Disimilaridad intra-cluster
k_modelo$withindiff

# Iteraciones del Algoritmo
k_modelo$iterations
```

```{r, collapse=TRUE, echo=FALSE, fig.align='center'}
grupo <- k_modelo$cluster
info_personal_cluster <- cbind(info_personal, grupo)

grid.arrange(# SEXO

ggplot(info_personal_cluster, 
       aes(x = sexo, y = situ_labo)) + 
  geom_jitter(color = grupo) + theme_minimal(),

ggplot(info_personal_cluster, 
       aes(x = sexo, y = estado_civil)) + 
  geom_jitter(color = grupo) + theme_minimal(),

ggplot(info_personal_cluster, 
       aes(x = sexo, y = grpo_edad)) + 
  geom_jitter(color = grupo) + theme_minimal(), 

ggplot(info_personal_cluster, 
       aes(x = sexo, y = niv_educ)) + 
  geom_jitter(color = grupo) + theme_minimal(),

# ESTADO CIVIL

ggplot(info_personal_cluster, 
       aes(x = estado_civil, y = situ_labo)) + 
  geom_jitter(color = grupo) + theme_minimal(),

ggplot(info_personal_cluster, 
       aes(x = estado_civil, y = grpo_edad)) + 
  geom_jitter(color = grupo) + theme_minimal(),

ggplot(info_personal_cluster, 
       aes(x = estado_civil, y = niv_educ)) + 
  geom_jitter(color = grupo) + theme_minimal(),

# SITUACI칍N LABRAL

ggplot(info_personal_cluster, 
       aes(x = situ_labo, y = grpo_edad)) + 
  geom_jitter(color = grupo) + theme_minimal(),

ggplot(info_personal_cluster, 
       aes(x = situ_labo, y = niv_educ)) + 
  geom_jitter(color = grupo) + theme_minimal(),

# GRUPO DE EDAD VS NIVEL EDUCATIVO

ggplot(info_personal_cluster, 
       aes(x = grpo_edad, y = niv_educ)) + 
  geom_jitter(color = grupo) + theme_minimal(), ncol = 5)
```

Si deseas observar los cambios sin tener que codificar en tu consola de R, checa [esta aplicaci칩n.](https://carlos-arguello.shinyapps.io/k-modes/)

# Referencias

-   [Luisa Fernanda Pastrana Ram칤rez y Nataly Jineth Roa Pe침a](http://repository.ut.edu.co/bitstream/001/1512/1/RIUT-ABA-spa-2015-Clasificaci%C3%B3n%20mediante%20k-modas%20para%20el%20caso%20de%20variables%20categ%C3%B3ricas.pdf)

-   [RDocumentation](https://www.rdocumentation.org/packages/klaR/versions/0.6-15/topics/kmodes)

### Contactame

游눹[GitHub](https://github.com/CarlosA-Ar)

游붚[Twitter](https://twitter.com/CarlosAAr6)
